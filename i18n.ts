import React, { createContext, useState, useContext, useEffect, FC } from 'react';

// Define the shape of the translation dictionary
interface Translations {
  [key: string]: string | ((params: { [key: string]: string | number }) => string);
}

// Define the translations for each language
const translations: { [lang: string]: Translations } = {
  fr: {
    dashboard: 'Tableau de Bord',
    fleetManagement: 'Gestion de la Flotte',
    bookings: 'Réservations',
    customerManagement: 'Gestion des Clients',
    financialManagement: 'Gestion Financière',
    settings: 'Paramètres',
    reports: 'Rapports',
    calendar: 'Calendrier',
    logout: 'Déconnexion',
    notifications: 'Notifications',
    noNewNotifications: 'Aucune nouvelle notification.',
    availableCars: 'Voitures Disponibles',
    totalIncome: 'Revenus Totaux',
    totalExpenses: 'Dépenses Totales',
    netProfit: 'Bénéfice Net',
    activeBookings: 'Réservations Active',
    monthlyProfitLoss: 'Pertes et Profits Mensuels',
    income: 'Revenus',
    expenses: 'Dépenses',
    upcomingBookingsAndRentedCars: 'Réservations à venir et Voitures Louées',
    from: 'De',
    to: 'À',
    viewDetails: 'Voir les Détails',
    addCar: 'Ajouter une Voiture',
    addNewCar: 'Ajouter une Nouvelle Voiture',
    manufacturer: 'Fabricant',
    model: 'Modèle',
    year: 'Année',
    color: 'Couleur',
    licensePlate: 'Plaque d\'immatriculation',
    engineCapacity: 'Cylindrée',
    fuelType: 'Type de Carburant',
    pricePerDay: 'Prix par Jour',
    day: 'Jour',
    days: 'jours',
    today: 'Aujourd\'hui',
    week: 'Semaine',
    month: 'Mois',
    addBookingOnDate: (params) => `Ajouter une réservation pour le ${params.date}`,
    nextServiceDate: 'Prochaine Date d\'Entretien',
    carImage: 'Image de la Voiture',
    preview: 'Aperçu',
    selectImage: 'Choisir une image',
    pleaseSelectCarImage: 'Veuillez sélectionner une image pour la voiture.',
    add: 'Ajouter',
    newBooking: 'Nouvelle Réservation',
    addNewBooking: 'Ajouter une Nouvelle Réservation',
    selectCustomer: 'Sélectionner un client',
    selectCar: 'Sélectionner une voiture',
    datesInvalid: 'La date de fin doit être après la date de début.',
    carUnavailableInDates: 'Voiture non disponible pour les dates sélectionnées.',
    bookNow: 'Réserver Maintenant',
    addBookingSoon: 'La fenêtre d\'ajout de réservation sera bientôt implémentée.',
    car: 'Voiture',
    customer: 'Client',
    startDate: 'Date de Début',
    endDate: 'Date de Fin',
    totalPrice: 'Prix Total',
    status: 'Statut',
    actions: 'Actions',
    finished: 'Terminée',
    active: 'Active',
    printContract: 'Imprimer le Contrat',
    addExpense: 'Ajouter une Dépense',
    exportToCsv: 'Exporter en CSV',
    filterByDate: 'Filtrer par Date',
    transactionLog: 'Journal des Transactions',
    type: 'Type',
    category: 'Catégorie',
    description: 'Description',
    amount: 'Montant',
    addNewExpense: 'Ajouter une Nouvelle Dépense',
    date: 'Date',
    expenseDetails: 'Détails de la dépense',
    addCustomer: 'Ajouter un Client',
    name: 'Nom',
    phoneNumber: 'Numéro de téléphone',
    email: 'E-mail',
    emailOptional: 'E-mail (Facultatif)',
    addNewCustomer: 'Ajouter un Nouveau Client',
    fullName: 'Nom complet',
    error: 'Erreur',
    carNotFound: 'Voiture non trouvée.',
    backToFleet: 'Retour à la Flotte',
    maintenanceHistory: 'Historique de Maintenance',
    addRecord: 'Ajouter un Enregistrement',
    noMaintenanceRecords: 'Aucun enregistrement de maintenance.',
    carDocuments: 'Documents du Véhicule',
    addDocument: 'Ajouter un Document',
    viewDocument: 'Voir le document',
    uploadFile: 'Veuillez télécharger un fichier.',
    documentFile: 'Fichier du document',
    noDocuments: 'Aucun document.',
    cost: 'Coût',
    addMaintenanceRecord: 'Ajouter un Enregistrement de Maintenance',
    addNewDocument: 'Ajouter un Nouveau Document',
    documentNamePlaceholder: 'Nom du document (ex: Assurance)',
    enterSecretCode: 'Veuillez entrer le code secret pour accéder',
    secretCode: 'Code Secret',
    login: 'Connexion',
    demoAccessCodes: 'Codes d\'accès démo',
    incorrectSecretCode: 'Code secret incorrect.',
    bookingNotFound: 'Réservation non trouvée.',
    contractPreview: 'Aperçu du Contrat',
    print: 'Imprimer',
    backToBookings: 'Retour aux Réservations',
    carRentalContract: 'Contrat de Location de Voiture',
    editedOn: 'Édité le',
    partyOne: 'Partie 1 (Le Loueur)',
    partyTwo: 'Partie 2 (Le Locataire)',
    rentedCarDetails: 'Détails de la Voiture Louée',
    rentalPeriodDetails: 'Détails de la Période de Location',
    financialDetails: 'Détails Financiers',
    totalRentalAmount: 'Montant Total de la Location',
    signaturePartyOne: 'Signature Partie 1 (Le Loueur)',
    signaturePartyTwo: 'Signature Partie 2 (Le Locataire)',
    unauthorizedAccess: 'Vous n\'êtes pas autorisé à accéder à cette page.',
    unauthorizedAccess_desc: 'Cette section est réservée aux administrateateurs.',
    carDetails: 'Détails de la Voiture',
    expires: 'Expire le',
    valid_period: (params) => `Valide (${params.days} jours)`,
    expired: 'Expiré',
    expires_soon_period: (params) => `Expire bientôt (${params.days} jours)`,
    notif_doc_expires: (params) => `Document (${params.docName}) pour ${params.carName} expire dans ${params.days} jours.`,
    notif_maintenance_due: (params) => `L'entretien de ${params.carName} est prévu dans ${params.days} jours.`,
    notif_new_booking: (params) => `Nouvelle réservation pour ${params.carName}.`,
    financialReports: 'Rapports Financiers',
    periodProfitLoss: 'Bénéfices & Pertes par Période',
    expenseAnalysisByCategory: 'Analyse des Dépenses par Catégorie',
    carProfitability: 'Rentabilité par Voiture',
    netProfitPerCar: 'Bénéfice Net',
    documents: 'Documents',
    remove: 'Retirer',
    documentName: 'Nom du document',
    addThisDocument: 'Ajouter ce document',
    addDocumentToList: 'Ajouter le document',
    noDocumentsAdded: 'Aucun document ajouté pour le moment.',
    documentNameAndFileRequired: 'Le nom et le fichier du document sont requis.',
    viewDocuments: 'Voir les documents',
    customerDocuments: 'Documents du Client',
    noCustomerDocuments: 'Aucun document pour ce client.',
    nationalId: 'N° de Carte Nationale',

    // Calendar Drag & Drop & Modal
    bookingDetails: 'Détails de la réservation',
    editBooking: 'Modifier la réservation',
    deleteBooking: 'Supprimer la réservation',
    confirmDeleteBooking: 'Êtes-vous sûr de vouloir supprimer cette réservation ?',
    dragToModify: 'Glisser pour modifier',
    bookingConflictError: 'Erreur : Conflit de réservation. La voiture n\'est pas disponible à cette date.',
    close: 'Fermer',
    edit: 'Modifier',
    delete: 'Supprimer',
    download: 'Télécharger',
    saveChanges: 'Enregistrer les modifications',

    // Settings Page
    userManagement: 'Gestion des Utilisateurs',
    addUser: 'Ajouter Utilisateur',
    addNewUser: 'Ajouter un Nouvel Utilisateur',
    role: 'Rôle',
    password: 'Mot de passe',
    confirmDeleteUser: 'Êtes-vous sûr de vouloir supprimer cet utilisateur ?',
    cannotDeleteAdmin: 'Impossible de supprimer un compte administrateur.',
    cannotDeleteSelf: 'Vous ne pouvez pas supprimer votre propre compte.',
    notificationSettings: 'Paramètres des Notifications',
    notificationDaysPrompt: 'M\'avertir jours avant l\'expiration d\'un document',
    companyInformation: 'Informations sur l\'Entreprise',
    companyName: 'Nom de l\'entreprise',
    address: 'Adresse',
    save: 'Enregistrer',
    dataManagement: 'Gestion des Données',
    exportData: 'Exporter les Données',
    importData: 'Importer les Données',
    importConfirmation: 'Êtes-vous sûr ? Cela écrasera toutes les données actuelles.',
    importSuccess: 'Données importées avec succès !',
    importError: 'Erreur lors de l\'importation des données. Fichier invalide.',
    pricingSeasons: 'Saisons de Tarification',
    addSeason: 'Ajouter une Saison',
    seasonName: 'Nom de la saison',
    multiplier: 'Multiplicateur (ex: 1.2 pour +20%)',

    // WhatsApp
    confirmViaWhatsapp: 'Confirmer via WhatsApp',
    sendPickupReminder: 'Envoyer rappel (Départ)',
    sendReturnReminder: 'Envoyer rappel (Retour)',
    whatsapp_confirmation_message: (params) => `Bonjour ${params.customerName}, nous confirmons votre réservation de la ${params.carName} du ${params.startDate} au ${params.endDate}. Montant total : ${params.totalPrice} ${params.currency}. Cordialement, ${params.companyName}.`,
    whatsapp_pickup_reminder_message: (params) => `Bonjour ${params.customerName}, petit rappel pour la récupération de votre ${params.carName} demain, le ${params.startDate}. Nous vous attendons ! Cordialement, ${params.companyName}.`,
    whatsapp_return_reminder_message: (params) => `Bonjour ${params.customerName}, nous vous rappelons que votre location de la ${params.carName} se termine demain, le ${params.endDate}. Cordialement, ${params.companyName}.`,

    // Check-in / Check-out
    vehicleCheck: 'Contrôle du Véhicule',
    backToChecklist: 'Retour à la liste',
    checkOut_departure: 'Check-out (Départ)',
    checkIn_return: 'Check-in (Retour)',
    mileage: 'Kilométrage',
    fuelLevel: 'Niveau de carburant',

    // Enums
    Available: 'Disponible',
    Rented: 'Louée',
    Maintenance: 'En Maintenance',
    Admin: 'Administrateur',
    Employee: 'Employé',
    Income: 'Revenu',
    Expense: 'Dépense',
    Rental: 'Location',
    Fuel: 'Carburant',
    Insurance: 'Assurance',
    Salaries: 'Salaires',
    Rent: 'Loyer',
    ExtraFee: 'Frais Supplémentaires',
    Other: 'Autre',
    Document: 'Document',
    Booking: 'Réservation',
    
    // Colors & Fuels
    Blanc: 'Blanc',
    Argent: 'Argent',
    Noir: 'Noir',
    Bleu: 'Bleu',
    Essence: 'Essence',
    Diesel: 'Diesel',
    'Électrique': 'Électrique',
    
    currency: 'D.M.'
  },
  ar: {
    dashboard: 'لوحة التحكم',
    fleetManagement: 'إدارة الأسطول',
    bookings: 'الحجوزات',
    customerManagement: 'إدارة العملاء',
    financialManagement: 'الإدارة المالية',
    settings: 'الإعدادات',
    reports: 'التقارير',
    calendar: 'التقويم',
    logout: 'تسجيل الخروج',
    notifications: 'الإشعارات',
    noNewNotifications: 'لا توجد إشعارات جديدة.',
    availableCars: 'سيارات متاحة',
    totalIncome: 'إجمالي المداخيل',
    totalExpenses: 'إجمالي المصاريف',
    netProfit: 'صافي الربح',
    activeBookings: 'الحجوزات النشطة',
    monthlyProfitLoss: 'الأرباح والخسائر الشهرية',
    income: 'المداخيل',
    expenses: 'المصاريف',
    upcomingBookingsAndRentedCars: 'الحجوزات القادمة والسيارات المؤجرة',
    from: 'من',
    to: 'إلى',
    viewDetails: 'عرض التفاصيل',
    addCar: 'إضافة سيارة',
    addNewCar: 'إضافة سيارة جديدة',
    manufacturer: 'الشركة المصنعة',
    model: 'الموديل',
    year: 'سنة الصنع',
    color: 'اللون',
    licensePlate: 'رقم اللوحة',
    engineCapacity: 'سعة المحرك',
    fuelType: 'نوع الوقود',
    pricePerDay: 'السعر لليوم',
    day: 'يوم',
    days: 'أيام',
    today: 'اليوم',
    week: 'أسبوع',
    month: 'شهر',
    addBookingOnDate: (params) => `إضافة حجز بتاريخ ${params.date}`,
    nextServiceDate: 'تاريخ الصيانة التالي',
    carImage: 'صورة السيارة',
    preview: 'معاينة',
    selectImage: 'اختر صورة',
    pleaseSelectCarImage: 'يرجى اختيار صورة للسيارة.',
    add: 'إضافة',
    newBooking: 'حجز جديد',
    addNewBooking: 'إضافة حجز جديد',
    selectCustomer: 'اختر العميل',
    selectCar: 'اختر السيارة',
    datesInvalid: 'تاريخ الانتهاء يجب أن يكون بعد تاريخ البدء.',
    carUnavailableInDates: 'السيارة غير متاحة في التواريخ المحددة.',
    bookNow: 'احجز الآن',
    addBookingSoon: 'سيتم تنفيذ نافذة إضافة الحجز قريبًا.',
    car: 'السيارة',
    customer: 'العميل',
    startDate: 'تاريخ البدء',
    endDate: 'تاريخ الانتهاء',
    totalPrice: 'السعر الإجمالي',
    status: 'الحالة',
    actions: 'الإجراءات',
    finished: 'منتهية',
    active: 'نشطة',
    printContract: 'طباعة العقد',
    addExpense: 'إضافة مصروف',
    exportToCsv: 'تصدير إلى CSV',
    filterByDate: 'فلترة حسب التاريخ',
    transactionLog: 'سجل المعاملات',
    type: 'النوع',
    category: 'الفئة',
    description: 'الوصف',
    amount: 'المبلغ',
    addNewExpense: 'إضافة مصروف جديد',
    date: 'التاريخ',
    expenseDetails: 'تفاصيل المصروف',
    addCustomer: 'إضافة عميل',
    name: 'الاسم',
    phoneNumber: 'رقم الهاتف',
    email: 'البريد الإلكتروني',
    emailOptional: 'البريد الإلكتروني (اختياري)',
    addNewCustomer: 'إضافة عميل جديد',
    fullName: 'الاسم الكامل',
    error: 'خطأ',
    carNotFound: 'لم يتم العثور على السيارة.',
    backToFleet: 'العودة للأسطول',
    maintenanceHistory: 'سجل الصيانة',
    addRecord: 'إضافة سجل',
    noMaintenanceRecords: 'لا توجد سجلات صيانة.',
    carDocuments: 'وثائق السيارة',
    addDocument: 'إضافة وثيقة',
    viewDocument: 'عرض الوثيقة',
    uploadFile: 'الرجاء رفع ملف.',
    documentFile: 'ملف الوثيقة',
    noDocuments: 'لا توجد وثائق.',
    cost: 'التكلفة',
    addMaintenanceRecord: 'إضافة سجل صيانة',
    addNewDocument: 'إضافة وثيقة جديدة',
    documentNamePlaceholder: 'اسم الوثيقة (مثال: تأمين)',
    enterSecretCode: 'الرجاء إدخال الرمز السري للوصول',
    secretCode: 'الرمز السري',
    login: 'دخول',
    demoAccessCodes: 'رموز الدخول التجريبية',
    incorrectSecretCode: 'الرمز السري غير صحيح.',
    bookingNotFound: 'الحجز غير موجود.',
    contractPreview: 'معاينة عقد الكراء',
    print: 'طباعة',
    backToBookings: 'العودة للحجوزات',
    carRentalContract: 'عقد كراء سيارة',
    editedOn: 'تم تحريره بتاريخ',
    partyOne: 'الطرف الأول (المؤجر)',
    partyTwo: 'الطرف الثاني (المستأجر)',
    rentedCarDetails: 'تفاصيل السيارة المؤجرة',
    rentalPeriodDetails: 'تفاصيل مدة الكراء',
    financialDetails: 'التفاصيل المالية',
    totalRentalAmount: 'المبلغ الإجمالي للكراء',
    signaturePartyOne: 'توقيع الطرف الأول (المؤجر)',
    signaturePartyTwo: 'توقيع الطرف الثاني (المستأجر)',
    unauthorizedAccess: 'غير مصرح لك بالوصول لهذه الصفحة.',
    unauthorizedAccess_desc: 'هذا القسم مخصص للمديرين فقط.',
    carDetails: 'تفاصيل السيارة',
    expires: 'انتهاء',
    valid_period: (params) => `صالح (${params.days} يوم)`,
    expired: 'منتهي',
    expires_soon_period: (params) => `ينتهي قريباً (${params.days} يوم)`,
    notif_doc_expires: (params) => `وثيقة (${params.docName}) لسيارة ${params.carName} تنتهي خلال ${params.days} يوم.`,
    notif_maintenance_due: (params) => `صيانة سيارة ${params.carName} قادمة خلال ${params.days} يوم.`,
    notif_new_booking: (params) => `حجز جديد لسيارة ${params.carName}.`,
    financialReports: 'تقارير مالية',
    periodProfitLoss: 'الأرباح والخسائر للفترة',
    expenseAnalysisByCategory: 'تحليل المصاريف حسب الفئة',
    carProfitability: 'ربحية كل سيارة',
    netProfitPerCar: 'صافي الربح',
    documents: 'الوثائق',
    remove: 'إزالة',
    documentName: 'اسم الوثيقة',
    addThisDocument: 'إضافة هذه الوثيقة',
    addDocumentToList: 'إضافة الوثيقة',
    noDocumentsAdded: 'لم تتم إضافة أي وثائق بعد.',
    documentNameAndFileRequired: 'اسم الوثيقة والملف مطلوبان.',
    viewDocuments: 'عرض الوثائق',
    customerDocuments: 'وثائق العميل',
    noCustomerDocuments: 'لا توجد وثائق لهذا العميل.',
    nationalId: 'رقم البطاقة الوطنية',

    // Calendar Drag & Drop & Modal
    bookingDetails: 'تفاصيل الحجز',
    editBooking: 'تعديل الحجز',
    deleteBooking: 'حذف الحجز',
    confirmDeleteBooking: 'هل أنت متأكد من رغبتك في حذف هذا الحجز؟',
    dragToModify: 'اسحب للتعديل',
    bookingConflictError: 'خطأ: تضارب في الحجز. السيارة غير متاحة في هذا التاريخ.',
    close: 'إغلاق',
    edit: 'تعديل',
    delete: 'حذف',
    download: 'تحميل',
    saveChanges: 'حفظ التغييرات',

    // Settings Page
    userManagement: 'إدارة المستخدمين',
    addUser: 'إضافة مستخدم',
    addNewUser: 'إضافة مستخدم جديد',
    role: 'الدور',
    password: 'كلمة المرور',
    confirmDeleteUser: 'هل أنت متأكد أنك تريد حذف هذا المستخدم؟',
    cannotDeleteAdmin: 'لا يمكن حذف حساب مدير.',
    cannotDeleteSelf: 'لا يمكنك حذف حسابك الخاص.',
    notificationSettings: 'إعدادات الإشعارات',
    notificationDaysPrompt: 'أعلمني قبل انتهاء صلاحية الوثيقة بـ',
    companyInformation: 'معلومات الشركة',
    companyName: 'اسم الشركة',
    address: 'العنوان',
    save: 'حفظ',
    dataManagement: 'إدارة البيانات',
    exportData: 'تصدير البيانات',
    importData: 'استيراد البيانات',
    importConfirmation: 'هل أنت متأكد؟ هذا الإجراء سيحذف جميع البيانات الحالية.',
    importSuccess: 'تم استيراد البيانات بنجاح!',
    importError: 'خطأ في استيراد البيانات. الملف غير صالح.',
    pricingSeasons: 'مواسم التسعير',
    addSeason: 'إضافة موسم',
    seasonName: 'اسم الموسم',
    multiplier: 'المضاعف (مثال: 1.2 لـ +20%)',

    // WhatsApp
    confirmViaWhatsapp: 'تأكيد عبر واتساب',
    sendPickupReminder: 'إرسال تذكير (الاستلام)',
    sendReturnReminder: 'إرسال تذكير (التسليم)',
    whatsapp_confirmation_message: (params) => `مرحبًا ${params.customerName}، نؤكد حجزكم لسيارة ${params.carName} من ${params.startDate} إلى ${params.endDate}. المبلغ الإجمالي: ${params.totalPrice} ${params.currency}. مع تحيات، ${params.companyName}.`,
    whatsapp_pickup_reminder_message: (params) => `مرحبًا ${params.customerName}، تذكير باستلام سيارتكم ${params.carName} غدًا بتاريخ ${params.startDate}. نتطلع لرؤيتكم! مع تحيات، ${params.companyName}.`,
    whatsapp_return_reminder_message: (params) => `مرحبًا ${params.customerName}، نذكركم بأن فترة إيجاركم لسيارة ${params.carName} تنتهي غدًا بتاريخ ${params.endDate}. مع تحيات، ${params.companyName}.`,
    
    // Check-in / Check-out
    vehicleCheck: 'فحص المركبة',
    backToChecklist: 'العودة للقائمة',
    checkOut_departure: 'فحص الخروج (المغادرة)',
    checkIn_return: 'فحص الدخول (العودة)',
    mileage: 'الكيلومتراج',
    fuelLevel: 'مستوى الوقود',

    // Enums
    Available: 'متاحة',
    Rented: 'مؤجرة',
    Maintenance: 'تحت الصيانة',
    Admin: 'مدير',
    Employee: 'موظف',
    Income: 'مدخول',
    Expense: 'مصروف',
    Rental: 'كراء',
    Fuel: 'وقود',
    Insurance: 'تأمين',
    Salaries: 'رواتب',
    Rent: 'إيجار',
    ExtraFee: 'رسوم إضافية',
    Other: 'مصاريف تشغيلية أخرى',
    Document: 'وثيقة',
    Booking: 'حجز',
    
    // Colors & Fuels
    Blanc: 'أبيض',
    Argent: 'فضي',
    Noir: 'أسود',
    Bleu: 'أزرق',
    Essence: 'بنزين',
    Diesel: 'ديزل',
    'Électrique': 'كهرباء',
    
    currency: 'د.م.'
  }
};

interface LanguageContextType {
  language: string;
  changeLanguage: (lang: string) => void;
  t: (key: string, params?: { [key: string]: string | number }) => string;
}

const LanguageContext = createContext<LanguageContextType | undefined>(undefined);

export const LanguageProvider: FC<{ children: React.ReactNode }> = ({ children }) => {
  const [language, setLanguage] = useState('fr'); // Default to French

  useEffect(() => {
    const dir = language === 'ar' ? 'rtl' : 'ltr';
    document.documentElement.lang = language;
    document.documentElement.dir = dir;
    document.documentElement.style.setProperty('--spacing-rtl-3', language === 'ar' ? '0 0.75rem' : '0.75rem 0');
  }, [language]);

  const changeLanguage = (lang: string) => {
    setLanguage(lang);
  };

  const t = (key: string, params?: { [key: string]: string | number }): string => {
    const translation = translations[language][key] || key;
    if (typeof translation === 'function') {
        return translation(params || {});
    }
    return translation;
  };

  return React.createElement(
    LanguageContext.Provider,
    { value: { language, changeLanguage, t } },
    children
  );
};

export const useTranslation = (): LanguageContextType => {
  const context = useContext(LanguageContext);
  if (!context) {
    throw new Error('useTranslation must be used within a LanguageProvider');
  }
  return context;
};